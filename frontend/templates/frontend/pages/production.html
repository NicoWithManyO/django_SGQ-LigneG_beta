{% extends 'frontend/base.html' %}

{% block title %}Production - SGQ Ligne G{% endblock %}

{% block extra_css %}
<!-- Alpine.js n'a pas de fichier CSS, c'est uniquement du JavaScript -->
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-fluid">
        <div class="row g-3">
            <!-- Colonne gauche -->
            <div class="col-lg-3">
                <!-- Bloc Fiche de Poste -->
                <div class="accordion" id="accordionPoste">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePoste" aria-expanded="true">
                                <i class="bi bi-card-list me-2"></i> Fiche de Poste
                            </button>
                        </h2>
                        <div id="collapsePoste" class="accordion-collapse collapse show">
                            {% include 'frontend/components/shift-form.html' %}
                        </div>
                    </div>
                </div>

                <!-- Bloc Ordre de Fabrication -->
                <div class="accordion mt-3" id="accordionOF">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOF" aria-expanded="true">
                                <i class="bi bi-list-task me-2"></i> Ordre de Fabrication
                            </button>
                        </h2>
                        <div id="collapseOF" class="accordion-collapse collapse show">
                            {% include 'frontend/components/production-order.html' %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne centrale -->
            <div class="col-lg-6">
                <!-- Bloc Déclaration de Temps -->
                <div class="accordion" id="accordionTemps">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTemps" aria-expanded="true"
                                    x-data="{ tempsTotal: window.sessionData?.temps_total || '0h00' }"
                                    x-init="window.addEventListener('lost-time-updated', (e) => { tempsTotal = e.detail.tempsTotal; })">
                                <i class="bi bi-clock me-2"></i> Déclaration de Temps :&nbsp;<span x-text="tempsTotal">0h00</span>
                            </button>
                        </h2>
                        <div id="collapseTemps" class="accordion-collapse collapse show">
                            {% include 'frontend/components/time-declaration.html' %}
                        </div>
                    </div>
                </div>

                <!-- Bloc Profil -->
                <div class="accordion mt-3" id="accordionProfil">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProfil" aria-expanded="true">
                                <i class="bi bi-graph-up me-2"></i> Profil : 80g/m² (Permissif)
                            </button>
                        </h2>
                        <div id="collapseProfil" class="accordion-collapse collapse show">
                            {% include "frontend/components/profile.html" %}
                        </div>
                    </div>
                </div>

                <!-- Bloc Zone Rouleau -->
                <div class="mt-3">
                    <div class="bg-light p-3 rounded">
                        <!-- Container Zone Rouleau -->
                        <div class="zone-rouleau-container" x-data="{ 
                            status: 'standard',
                            nbEpaisseurs: 0,
                            nbNok: 0,
                            nbDefauts: 0
                        }">
                            <!-- Badge de conformité avec compteurs -->
                            <div>
                                {% include 'frontend/components/badge-conformite.html' %}
                            </div>
                            
                            <!-- Rouleau -->
                            {% include 'frontend/components/roll.html' %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne droite -->
            <div class="col-lg-3">
                <!-- Bloc Check-list -->
                <div class="accordion" id="accordionChecklist">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChecklist" aria-expanded="true">
                                <i class="bi bi-check2-square me-2"></i> Check-list
                            </button>
                        </h2>
                        <div id="collapseChecklist" class="accordion-collapse collapse show">
                            {% include 'frontend/components/checklist.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script>
// Passer les données de session au JS
window.sessionData = {{ session_data|safe }};
// Passer les données des opérateurs
window.operatorsData = {{ operators_json|safe }};
</script>
<script src="{% static 'frontend/js/common.js' %}"></script>
<script src="{% static 'frontend/js/api.js' %}"></script>
<script src="{% static 'frontend/js/data-loader.js' %}"></script>
<script src="{% static 'frontend/js/shared-mixins.js' %}"></script>
<script src="{% static 'frontend/js/roll-calculations.js' %}"></script>
<script src="{% static 'frontend/js/roll-business-logic.js' %}"></script>
<script src="{% static 'frontend/js/shift-form.js' %}"></script>
<script src="{% static 'frontend/js/profile.js' %}"></script>
<script src="{% static 'frontend/js/production-order.js' %}"></script>
<script src="{% static 'frontend/js/time-declaration.js' %}"></script>
<script src="{% static 'frontend/js/sticky-bottom.js' %}"></script>
<script src="{% static 'frontend/js/checklist.js' %}"></script>
<script src="{% static 'frontend/js/roll.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script>
// Attendre que Alpine soit prêt
document.addEventListener('alpine:init', () => {
    // Le store devrait être créé par data-loader.js
    setTimeout(() => {
        const appData = Alpine.store('appData');
        if (appData && typeof appData.init === 'function') {
            appData.init();
        }
    }, 100);
});
</script>
{% endblock %}